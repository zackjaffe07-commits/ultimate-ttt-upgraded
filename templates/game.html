<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Tic Tac Toe</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="bg" data-username="{{ current_user.username }}">

<canvas id="confetti-canvas"></canvas>

<!-- Victory Modal -->
<div id="victory-modal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h1 id="victory-text"></h1>
        <p id="victory-subtext"></p>
    </div>
</div>

<!-- Rules Modal -->
<div id="rules-modal" class="modal-overlay" style="display:none;">
    <div class="modal-content rules-modal-content">
        <div class="rules-modal-header">
            <h2>üìñ How to Play</h2>
            <button id="rules-close-btn" class="button secondary small">‚úï Close</button>
        </div>
        <div class="rules-body">
            <h3>The Basics</h3>
            <p>Ultimate Tic-Tac-Toe is played on a large 3√ó3 grid, where each cell contains a smaller 3√ó3 board.</p>
            <h3>The Golden Rule</h3>
            <p><strong>The cell you pick in a small board determines which small board your opponent must play in next.</strong></p>
            <h3>Winning a Small Board</h3>
            <p>Get three of your marks in a row on any small board. That board is then yours.</p>
            <h3>Winning the Game</h3>
            <p>Win three small boards in a row on the large grid.</p>
            <h3>Tiebreaker</h3>
            <p>If all small boards are decided and nobody has 3 in a row, the player with the most won small boards wins. Equal = draw.</p>
            <h3>Free Choice</h3>
            <p>If you're sent to an already-won or full board, you may play on <strong>any open cell</strong> in any available board.</p>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div id="settings-modal" class="modal-overlay" style="display:none;">
    <div class="modal-content settings-modal-content">
        <h2>‚öôÔ∏è Room Settings</h2>
        <p class="subtitle">Only the host can change these</p>

        <!-- Timer Type -->
        <div class="settings-row">
            <label style="font-weight:700; margin-bottom:10px; display:block;">‚è± Timer Mode</label>
            <div class="diff-radio-group" style="flex-wrap:wrap; gap:8px;">
                <label style="flex:1; min-width:120px; background:#f5f5f5; border-radius:10px; padding:10px; cursor:pointer; border:2px solid transparent;" id="lbl-timer-move">
                    <input type="radio" name="timer-type" value="move" checked style="margin-right:6px;">
                    <strong>Move Timer</strong><br>
                    <span style="font-size:0.8rem; opacity:0.6;">Each move has a countdown. Timeout plays a random move.</span>
                </label>
                <label style="flex:1; min-width:120px; background:#f5f5f5; border-radius:10px; padding:10px; cursor:pointer; border:2px solid transparent;" id="lbl-timer-game">
                    <input type="radio" name="timer-type" value="game" style="margin-right:6px;">
                    <strong>Game Timer</strong><br>
                    <span style="font-size:0.8rem; opacity:0.6;">Each player has a total time budget. Running out = forfeit.</span>
                </label>
                <label style="flex:1; min-width:120px; background:#f5f5f5; border-radius:10px; padding:10px; cursor:pointer; border:2px solid transparent;" id="lbl-timer-none">
                    <input type="radio" name="timer-type" value="none" style="margin-right:6px;">
                    <strong>No Timer</strong><br>
                    <span style="font-size:0.8rem; opacity:0.6;">Unlimited thinking time.</span>
                </label>
            </div>
        </div>

        <!-- Move Timer Settings -->
        <div class="settings-row" id="move-timer-row">
            <label>Per-move time: <strong id="timer-setting-display">30s</strong></label>
            <input type="range" id="timer-setting" min="10" max="300" step="5" value="30">
            <div class="settings-hints"><span>10s</span><span>5 min</span></div>
        </div>

        <!-- Game Timer Settings -->
        <div class="settings-row" id="game-timer-row" style="display:none;">
            <label>Time per player: <strong id="game-time-display">5:00</strong></label>
            <input type="range" id="game-time-setting" min="30" max="1800" step="30" value="300">
            <div class="settings-hints"><span>30s</span><span>30 min</span></div>
            <label style="margin-top:12px; display:block;">Increment (after each move): <strong id="increment-display">0s</strong></label>
            <input type="range" id="increment-setting" min="0" max="30" step="1" value="0">
            <div class="settings-hints"><span>0s</span><span>30s</span></div>
        </div>

        <!-- Who Goes First (online games) -->
        <div class="settings-row" id="first-player-row">
            <label style="margin-bottom:8px; display:block; font-weight:600;">üë§ Who Goes First (X)</label>
            <div class="diff-radio-group">
                <label><input type="radio" name="first-player" value="host" checked> Host</label>
                <label><input type="radio" name="first-player" value="joiner"> Joiner</label>
                <label><input type="radio" name="first-player" value="random"> üé≤ Random</label>
            </div>
        </div>

        <!-- AI Settings -->
        <div class="settings-row ai-difficulty-row" style="display:none;">
            <label style="margin-bottom:8px; display:block; font-weight:600;">ü§ñ AI Difficulty</label>
            <div class="diff-radio-group">
                <label><input type="radio" name="ai-diff" value="easy"> üòÖ Easy</label>
                <label><input type="radio" name="ai-diff" value="medium" checked> ü§ñ Medium</label>
                <label><input type="radio" name="ai-diff" value="hard"> üíÄ Hard</label>
            </div>
        </div>

        <div class="settings-row ai-difficulty-row" style="display:none;">
            <label style="margin-bottom:8px; display:block; font-weight:600;">‚ö° Play as</label>
            <div class="diff-radio-group">
                <label><input type="radio" name="ai-order" value="first" checked> Go First (X)</label>
                <label><input type="radio" name="ai-order" value="second"> Go Second (O)</label>
            </div>
        </div>

        <div class="settings-actions">
            <button id="settings-apply-btn" class="button primary small">Apply</button>
            <button id="settings-cancel-btn" class="button secondary small">Cancel</button>
        </div>
    </div>
</div>

<div class="game-page-layout">
    <!-- ===== GAME AREA ===== -->
    <div class="game-container">
        <div class="top-bar">
            <div>
                <h2>Room: {{ room }} <span id="ranked-badge" class="ranked-badge" style="display:none;">üèÜ Ranked</span></h2>
                <p id="player" class="muted"></p>
            </div>
            <div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap;">
                <button id="sound-toggle" title="Toggle sound">üîä</button>
                <button id="rules-btn" title="Rules">üìñ</button>
                <button id="settings-btn" class="button secondary small" title="Room settings" style="display:none;">‚öôÔ∏è Settings</button>
                <button id="leave-btn" class="button danger small" style="display:none;">Leave</button>
                <button id="spectate-btn" class="button secondary small" style="display:none;">üëÅ Spectate</button>
                <a href="/home" id="spectator-home-btn" class="button secondary small" style="display:none;">‚Üê Home</a>
                <button id="action" class="button primary small" style="display:none;">Start</button>
                <button id="takeback-btn" class="button secondary small" style="display:none;" title="Request to take back your last move">‚Ü© Takeback</button>
                <!-- Spectator join button -->
                <button id="join-game-btn" class="button primary small" style="display:none;">‚ñ∂ Join Game</button>
                <div id="post-game-actions" style="display:none;">
                    <button id="rematch-btn" class="button primary small">Rematch</button>
                    <a href="{{ url_for('home') }}" id="home-btn" class="button secondary small">Home</a>
                </div>
            </div>
        </div>

        <div class="status-card">
            <p id="status">Waiting for players‚Ä¶</p>
            <div id="timer-display" class="hidden"></div>
        </div>
        <div id="takeback-request-card" class="status-card" style="display:none; background: rgba(255,200,0,0.15); border: 1px solid rgba(255,200,0,0.5);">
            <p id="takeback-request-text">Opponent requests a takeback</p>
            <div style="display:flex; gap:8px; margin-top:8px;">
                <button id="takeback-accept-btn" class="button primary small">Accept</button>
                <button id="takeback-decline-btn" class="button danger small">Decline</button>
            </div>
        </div>

        <!-- Player info with per-player game clocks -->
        <div class="player-info-panel">
            <div class="player-slot">
                <div id="player-X" class="player-info"></div>
                <div class="player-clock" id="clock-X" style="display:none;"></div>
            </div>
            <div class="vs-separator">vs</div>
            <div class="player-slot">
                <div id="player-O" class="player-info"></div>
                <div class="player-clock" id="clock-O" style="display:none;"></div>
            </div>
        </div>

        <div class="board-wrapper">
            <div id="board"></div>
        </div>
    </div>

    <!-- ===== SIDEBAR ===== -->
    <div class="sidebar">
        <div class="card sidebar-card">
            <h3>Spectators</h3>
            <ul id="spectator-list"><li>No spectators yet.</li></ul>
        </div>

        <div class="card sidebar-card move-history-card">
            <div class="move-history-header">
                <h3>Move History</h3>
                <div class="history-nav-arrows" id="history-nav-arrows" style="display:none;">
                    <button id="history-prev-btn" class="history-arrow-btn" title="Previous move">&#8592;</button>
                    <button id="history-next-btn" class="history-arrow-btn" title="Next move / Live">&#8594;</button>
                </div>
                <span id="history-nav-hint" class="history-nav-hint" style="display:none;">‚Üê ‚Üí keys</span>
            </div>
            <div id="history-viewing-banner" class="history-viewing-banner" style="display:none;">
                <span id="history-viewing-label">Viewing move 1</span>
                <button id="history-return-btn" class="button secondary small">‚ñ∂ Live</button>
            </div>
            <ul id="move-history-list"><li style="color:#aaa; font-size:0.85rem;">No moves yet.</li></ul>
        </div>

        <div class="card sidebar-card chat-card">
            <h3>Chat</h3>
            <div id="chat-messages"></div>
            <div class="chat-input-area">
                <input type="text" id="chat-input" placeholder="Say something..." maxlength="200">
                <button id="send-chat-btn" class="button primary small">Send</button>
            </div>
            <div class="mute-controls">
                <label><input type="checkbox" id="mute-opponent"> Mute Opponent</label>
                <label><input type="checkbox" id="mute-spectators"> Mute Spectators</label>
            </div>
        </div>
    </div>
</div>

<script>const ROOM = "{{ room }}";</script>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script src="{{ url_for('static', filename='js/game.js') }}"></script>
</body>
</html>
