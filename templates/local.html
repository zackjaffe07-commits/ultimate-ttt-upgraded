<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local 2-Player ‚Äî Ultimate TTT</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="bg" data-username="{{ current_user.username }}">

<canvas id="confetti-canvas"></canvas>

<!-- Victory Modal -->
<div id="victory-modal" class="modal-overlay" style="display:none;">
    <div class="modal-content">
        <h1 id="victory-text"></h1>
        <p id="victory-subtext"></p>
    </div>
</div>

<div class="game-page-layout">
    <div class="game-container">
        <div class="top-bar">
            <div>
                <h2>üë• Local 2-Player</h2>
                <p id="turn-label" class="muted">X goes first</p>
            </div>
            <div style="display:flex; gap:6px; align-items:center;">
                <button id="sound-toggle" title="Toggle sound">üîä</button>
                <button id="new-game-btn" class="button primary small">New Game</button>
                <a href="{{ url_for('home') }}" class="button secondary small">Home</a>
            </div>
        </div>

        <div class="status-card">
            <p id="status">X's turn</p>
        </div>

        <div class="player-info-panel">
            <div id="player-X" class="player-info active-player">
                <div class="symbol X">X</div>
                <div class="username">Player X</div>
            </div>
            <div class="vs-separator">vs</div>
            <div id="player-O" class="player-info">
                <div class="symbol O">O</div>
                <div class="username">Player O</div>
            </div>
        </div>

        <div class="board-wrapper">
            <div id="board"></div>
        </div>
    </div>

    <div class="sidebar">
        <div class="card sidebar-card move-history-card">
            <div class="move-history-header">
                <h3>Move History</h3>
                <span id="history-nav-hint" class="history-nav-hint" style="display:none;">‚Üê ‚Üí to navigate</span>
            </div>
            <div id="history-viewing-banner" class="history-viewing-banner" style="display:none;">
                <span id="history-viewing-label">Viewing move 1</span>
                <button id="history-return-btn" class="button secondary small">‚ñ∂ Live</button>
            </div>
            <ul id="move-history-list"><li style="color:#aaa; font-size:0.85rem;">No moves yet.</li></ul>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/uttt.js') }}"></script>
<script>
// ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let game            = new UTTT();
let soundEnabled    = true;
let lastWinners     = Array(9).fill(null);
let historyIndex    = null;

const boardDiv             = document.getElementById("board");
const statusEl             = document.getElementById("status");
const turnLabel            = document.getElementById("turn-label");
const playerXDiv           = document.getElementById("player-X");
const playerODiv           = document.getElementById("player-O");
const moveHistoryList      = document.getElementById("move-history-list");
const historyViewingBanner = document.getElementById("history-viewing-banner");
const historyViewingLabel  = document.getElementById("history-viewing-label");
const historyReturnBtn     = document.getElementById("history-return-btn");
const historyNavHint       = document.getElementById("history-nav-hint");
const victoryModal         = document.getElementById("victory-modal");
const victoryText          = document.getElementById("victory-text");
const victorySubtext       = document.getElementById("victory-subtext");
const confettiCanvas       = document.getElementById("confetti-canvas");
const soundToggle          = document.getElementById("sound-toggle");
const newGameBtn           = document.getElementById("new-game-btn");

// ‚îÄ‚îÄ Sounds ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function beep(freq, dur, type = 'sine', vol = 0.3) {
    if (!soundEnabled) return;
    try {
        const osc = audioCtx.createOscillator(), gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.type = type; osc.frequency.value = freq;
        gain.gain.setValueAtTime(vol, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + dur);
        osc.start(); osc.stop(audioCtx.currentTime + dur);
    } catch(e) {}
}
const sounds = {
    place:   () => beep(440, 0.08, 'square', 0.2),
    win:     () => { beep(523,0.1); setTimeout(()=>beep(659,0.1),80); setTimeout(()=>beep(784,0.2),160); },
    gameWin: () => { [523,659,784,1047].forEach((f,i)=>setTimeout(()=>beep(f,0.15,'sine',0.35),i*90)); },
};
soundToggle.onclick = () => { soundEnabled = !soundEnabled; soundToggle.textContent = soundEnabled ? 'üîä' : 'üîá'; };

// ‚îÄ‚îÄ Confetti ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function launchConfetti() {
    const ctx = confettiCanvas.getContext('2d');
    confettiCanvas.width = window.innerWidth; confettiCanvas.height = window.innerHeight;
    const particles = Array.from({length:120}, () => ({
        x: Math.random()*window.innerWidth, y: Math.random()*-window.innerHeight*0.5,
        vx:(Math.random()-0.5)*4, vy:Math.random()*4+2,
        color:['#e74c3c','#3498db','#f39c12','#2ecc71','#9b59b6','#ffd700'][Math.floor(Math.random()*6)],
        w:Math.random()*10+5, h:Math.random()*6+3, rot:Math.random()*Math.PI*2, spin:(Math.random()-0.5)*0.2
    }));
    let frame=0;
    function animate(){
        ctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
        particles.forEach(p=>{
            p.x+=p.vx; p.y+=p.vy; p.rot+=p.spin; p.vy+=0.05;
            ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot);
            ctx.fillStyle=p.color; ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h); ctx.restore();
        });
        if(++frame<180) requestAnimationFrame(animate);
        else ctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
    }
    animate();
}

// ‚îÄ‚îÄ Move History ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateMoveHistory() {
    const history = game.moveHistory;
    moveHistoryList.innerHTML = '';
    if (history.length === 0) {
        moveHistoryList.innerHTML = '<li style="color:#aaa;font-size:0.85rem;">No moves yet.</li>';
        historyNavHint.style.display = 'none';
        historyViewingBanner.style.display = 'none';
        return;
    }
    historyNavHint.style.display = 'inline';
    history.forEach((m, i) => {
        const li  = document.createElement('li');
        const cls = m.player === 'X' ? 'hist-x' : 'hist-o';
        li.innerHTML = `<span class="hist-num">${i+1}.</span> <span class="${cls}">${m.player}</span> ‚Üí B${m.board+1} C${m.cell+1}`;
        li.dataset.index = i;
        li.classList.add('history-item');
        if (historyIndex === i) li.classList.add('history-selected');
        li.onclick = () => selectHistory(i);
        moveHistoryList.insertBefore(li, moveHistoryList.firstChild);
    });
    if (historyIndex !== null) {
        historyViewingBanner.style.display = 'flex';
        historyViewingLabel.textContent = `Viewing move ${historyIndex+1} of ${history.length}`;
    } else {
        historyViewingBanner.style.display = 'none';
    }
}

function selectHistory(index) {
    if (index < 0 || index >= game.moveHistory.length) return;
    historyIndex = index;
    drawBoardFromState(game.moveHistory[index].snapshot, true);
    updateHistoryHighlight();
    historyViewingBanner.style.display = 'flex';
    historyViewingLabel.textContent = `Viewing move ${historyIndex+1} of ${game.moveHistory.length}`;
}

function exitHistory() {
    historyIndex = null;
    historyViewingBanner.style.display = 'none';
    updateHistoryHighlight();
    drawBoardFromState(game.getState(), false);
    lastWinners = [...game.boardWinners];
}

function updateHistoryHighlight() {
    [...moveHistoryList.querySelectorAll('li.history-item')].forEach(li => {
        li.classList.toggle('history-selected', parseInt(li.dataset.index) === historyIndex);
    });
}

document.addEventListener('keydown', e => {
    const h = game.moveHistory;
    if (h.length === 0) return;
    if (e.key === 'ArrowLeft') {
        e.preventDefault();
        if (historyIndex === null) selectHistory(h.length-1);
        else if (historyIndex > 0) selectHistory(historyIndex-1);
    } else if (e.key === 'ArrowRight') {
        e.preventDefault();
        if (historyIndex !== null) {
            if (historyIndex < h.length-1) selectHistory(historyIndex+1);
            else exitHistory();
        }
    } else if (e.key === 'Escape' && historyIndex !== null) {
        exitHistory();
    }
});
historyReturnBtn.onclick = exitHistory;

// ‚îÄ‚îÄ Board Rendering ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawBoardFromState(state, isHistoryView) {
    boardDiv.innerHTML = "";
    const isMyTurn = !isHistoryView && !state.gameWinner;
    const validBoards = new Set();
    if (isMyTurn) {
        if (state.forced !== null && state.forced !== undefined) {
            validBoards.add(state.forced);
        } else {
            for (let i = 0; i < 9; i++) if (!state.winners[i]) validBoards.add(i);
        }
    }
    for (let b = 0; b < 9; b++) {
        const mini = document.createElement("div");
        mini.className = "mini-board";
        const boardWon  = state.winners[b];
        const isMetaWin = state.gameWinLine && state.gameWinLine.includes(b);
        if (boardWon && boardWon !== 'D') {
            if (!isHistoryView && lastWinners[b] !== boardWon) {
                beep(523,0.1); setTimeout(()=>beep(659,0.1),80); setTimeout(()=>beep(784,0.2),160);
                mini.classList.add('win-board');
            }
            mini.classList.add(`won-${boardWon}`);
            const overlay = document.createElement("span");
            overlay.className = `overlay ${boardWon}`; overlay.textContent = boardWon;
            mini.appendChild(overlay);
        }
        if (isMetaWin) mini.classList.add('game-win');
        if (!isHistoryView && state.forced === b && !boardWon) mini.classList.add("forced");

        for (let c = 0; c < 9; c++) {
            const cell = document.createElement("div");
            const sym  = state.boards[b][c];
            cell.className = "cell";
            if (sym) {
                cell.classList.add(sym); cell.textContent = sym;
                if (!isHistoryView && state.lastMove && state.lastMove[0]===b && state.lastMove[1]===c)
                    cell.classList.add('placed');
            }
            if (state.lastMove && state.lastMove[0]===b && state.lastMove[1]===c)
                cell.classList.add('last-move');
            if (boardWon && boardWon!=='D' && state.boardWinLines && state.boardWinLines[b])
                if (state.boardWinLines[b].includes(c)) cell.classList.add('win-cell');
            if (isMyTurn && (!validBoards.has(b) || boardWon || sym))
                cell.classList.add('no-click');

            cell.onclick = () => {
                if (isHistoryView || historyIndex !== null) return;
                if (game.gameWinner) return;
                if (game.makeMove(b, c)) {
                    if (soundEnabled) beep(440, 0.08, 'square', 0.2);
                    refreshView();
                }
            };
            mini.appendChild(cell);
        }
        boardDiv.appendChild(mini);
    }
}

function updatePlayerPanels(state) {
    const xActive = state.player === 'X' && !state.gameWinner;
    const oActive = state.player === 'O' && !state.gameWinner;
    playerXDiv.className = `player-info${xActive ? ' active-player' : ''}`;
    playerODiv.className = `player-info${oActive ? ' active-player' : ''}`;
}

function refreshView() {
    if (historyIndex !== null) {
        // keep history view, just update the list
        updateMoveHistory();
        return;
    }
    const state = game.getState();
    drawBoardFromState(state, false);
    updateMoveHistory();
    updatePlayerPanels(state);
    lastWinners = [...game.boardWinners];

    if (game.gameWinner) {
        statusEl.textContent = game.gameWinner === 'D' ? "It's a draw!" : `${game.gameWinner === 'X' ? 'X' : 'O'} wins! üéâ`;
        if (game.gameWinner === 'D') {
            victoryText.textContent = "Draw!"; victorySubtext.textContent = "Evenly matched!";
        } else {
            victoryText.textContent = `Player ${game.gameWinner} Wins! üéâ`;
            victorySubtext.textContent = "Congratulations!";
            if (soundEnabled) { [523,659,784,1047].forEach((f,i)=>setTimeout(()=>beep(f,0.15,'sine',0.35),i*90)); }
            launchConfetti();
        }
        victoryModal.style.display = 'flex';
        setTimeout(() => { victoryModal.style.display = 'none'; }, 4000);
    } else {
        statusEl.textContent = `${state.player}'s turn`;
    }
}

function startNewGame() {
    game         = new UTTT();
    historyIndex = null;
    lastWinners  = Array(9).fill(null);
    victoryModal.style.display = 'none';
    statusEl.textContent = "X's turn";
    historyViewingBanner.style.display = 'none';
    refreshView();
}

newGameBtn.onclick = startNewGame;
victoryModal.onclick = () => { victoryModal.style.display = 'none'; };

// Initial render
drawBoardFromState(game.getState(), false);
</script>
</body>
</html>
